<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --sdui-pink: #d8507a;
            --sdui-bg: #ffffff;
            --sdui-light-gray: #f2f2f2;
            --sdui-border: #e8e8e8;
            --sdui-text: #2c2c2c;
            --sdui-gray-text: #8e8e93;
        }

        /* Viewport Fix: Verhindert das Verschwinden unter der Browserleiste */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, system-ui, sans-serif; }
        body { background-color: #f0f0f0; height: 100dvh; display: flex; justify-content: center; overflow: hidden; }

        #app {
            width: 100%; max-width: 500px; background: var(--sdui-bg); height: 100dvh;
            display: flex; flex-direction: column; position: relative;
        }

        .screen { display: none; flex-direction: column; height: 100%; width: 100%; }
        .screen.active { display: flex; }

        /* HEADER STYLE (Screenshot 1) */
        header { padding: 12px 20px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--sdui-border); }
        .header-title { display: flex; align-items: center; gap: 12px; }
        .header-title h1 { font-size: 32px; font-weight: 700; color: var(--sdui-text); }
        .header-icons { display: flex; gap: 20px; font-size: 22px; color: #555; }

        /* SEARCH & FILTER (Screenshot 1) */
        .search-container { padding: 10px 15px; display: flex; gap: 10px; align-items: center; }
        .search-bar { flex: 1; background: var(--sdui-light-gray); border-radius: 10px; padding: 10px 10px 10px 40px; border: none; font-size: 16px; position: relative; }
        .search-icon { position: absolute; left: 25px; color: var(--sdui-gray-text); }
        .filter-icon { font-size: 20px; color: var(--sdui-gray-text); }

        /* CHAT LISTE (Screenshot 1) */
        .chat-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; padding: 15px; border-bottom: 1px solid var(--sdui-border); align-items: center; cursor: pointer; }
        .avatar { width: 52px; height: 52px; border-radius: 50%; background: #2b6cb0; color: white; display: flex; 
                  align-items: center; justify-content: center; font-weight: bold; font-size: 18px; margin-right: 15px; flex-shrink: 0; overflow: hidden;}
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-content { flex: 1; overflow: hidden; }
        .chat-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
        .chat-name { font-weight: 600; font-size: 16px; color: var(--sdui-text); }
        .chat-time { font-size: 12px; color: var(--sdui-gray-text); }
        .chat-preview { font-size: 14px; color: var(--sdui-gray-text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* CHAT VIEW (Screenshot 2) */
        .messages { flex: 1; overflow-y: auto; padding: 15px; background: #fff; display: flex; flex-direction: column; gap: 10px; }
        .bubble { max-width: 85%; padding: 12px; border-radius: 15px; position: relative; }
        .bubble.received { align-self: flex-start; background: #fff; border: 1px solid var(--sdui-border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .bubble.sent { align-self: flex-end; background: #f2f2f7; color: #000; }
        .sender-tag { color: var(--sdui-pink); font-size: 11px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .verify-badge { width: 14px; height: 14px; }

        /* ACTION MENU (Screenshot 4) */
        .bottom-sheet { position: absolute; bottom: -100%; left: 0; width: 100%; background: white; border-radius: 20px 20px 0 0; transition: 0.3s; z-index: 200; padding: 20px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1); }
        .bottom-sheet.active { bottom: 0; }
        .sheet-header { display: flex; justify-content: center; margin-bottom: 20px; }
        .sheet-close { position: absolute; right: 20px; top: 20px; color: #ccc; cursor: pointer; }

        /* INPUT AREA */
        .input-area { padding: 15px; border-top: 1px solid var(--sdui-border); display: flex; align-items: center; gap: 12px; }
        .msg-input { flex: 1; background: var(--sdui-light-gray); border-radius: 20px; padding: 10px 15px; border: 1px solid var(--sdui-pink); outline: none; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-main" class="screen active">
        <header>
            <div class="header-title">
                <h1>Chats</h1>
                <i class="fa-solid fa-circle-plus" style="color:var(--sdui-pink); font-size: 26px; cursor:pointer;" onclick="toggleSheet('sheet-create-group', true)"></i>
            </div>
            <div class="header-icons">
                <i class="fa-regular fa-bell"></i>
                <i class="fa-solid fa-circle-info"></i>
                <i class="fa-solid fa-bars" onclick="toggleSheet('sheet-menu', true)"></i>
            </div>
        </header>
        <div class="search-container">
            <i class="fa fa-search search-icon"></i>
            <input type="text" class="search-bar" placeholder="Suchen">
            <i class="fa-solid fa-sliders filter-icon"></i>
        </div>
        <div class="chat-list" id="global-chat-list">
            </div>
    </div>

    <div id="screen-chat" class="screen">
        <header style="justify-content: flex-start; gap: 15px;">
            <i class="fa fa-chevron-left" style="color:var(--sdui-pink); font-size:22px;" onclick="showScreen('screen-main')"></i>
            <div class="avatar" style="width:40px; height:40px;" id="active-chat-avatar">?</div>
            <div style="flex:1;">
                <b id="active-chat-name">Chat</b><br>
                <small style="color:gray;">Hier klicken für Chat Info</small>
            </div>
        </header>
        <div class="messages" id="message-list"></div>
        <div class="input-area">
            <i class="fa fa-plus" style="color:var(--sdui-pink); font-size:24px;" onclick="toggleSheet('sheet-actions', true)"></i>
            <input type="text" id="chat-input" class="msg-input" placeholder="Neue Nachricht">
            <i class="fa-solid fa-paper-plane" style="color:var(--sdui-pink); font-size:22px;" onclick="sendText()"></i>
        </div>
    </div>

    <div id="overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.3); z-index:150;" onclick="closeSheets()"></div>

    <div id="sheet-menu" class="bottom-sheet">
        <div class="sheet-close" onclick="closeSheets()"><i class="fa fa-times-circle"></i></div>
        <div style="padding: 10px 0;" onclick="alert('Profil coming soon')"><b>Account & Einstellungen</b></div>
        <hr style="opacity:0.2; margin: 15px 0;">
        <div style="color:red;" onclick="firebase.auth().signOut()"><b>Ausloggen</b></div>
    </div>

    <div id="sheet-create-group" class="bottom-sheet">
        <h3>Neue Gruppe erstellen</h3><br>
        <input type="text" id="new-group-name" class="msg-input" style="width:100%" placeholder="Gruppenname"><br><br>
        <button onclick="createGroup()" style="width:100%; padding:12px; background:var(--sdui-pink); color:white; border:none; border-radius:10px;">Erstellen</button>
    </div>

    <div id="sheet-actions" class="bottom-sheet">
        <div class="sheet-close" onclick="closeSheets()"><i class="fa fa-times-circle"></i></div>
        <h3 style="text-align:center; margin-bottom:20px;">Aktion auswählen</h3>
        <div style="display:flex; justify-content:space-around;">
            <div style="text-align:center;" onclick="triggerFile()"><i class="fa fa-image" style="font-size:30px; color:var(--sdui-pink); border:1px solid #eee; padding:15px; border-radius:12px;"></i><br>Medien</div>
            <div style="text-align:center;" onclick="alert('Kamera aktiv')"><i class="fa fa-camera" style="font-size:30px; color:var(--sdui-pink); border:1px solid #eee; padding:15px; border-radius:12px;"></i><br>Kamera</div>
        </div>
        <input type="file" id="file-hidden" hidden accept="image/*" onchange="uploadAndSend(this)">
    </div>
</div>

<script>
    // --- FIREBASE SETUP ---
    const firebaseConfig = { /* DEINE DATEN HIER */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ADMIN_EMAIL = "boxenjob5@gmail.com";
    const VERIFY_IMG = "https://static.wikia.nocookie.net/roblox/images/5/57/Verified_Badge.png";

    let currentUser = null;
    let activeChatId = "global";

    firebase.auth().onAuthStateChanged(user => {
        if(user) { 
            currentUser = user; 
            loadChats(); 
        } else { 
            /* Login Logic hier */ 
            alert("Bitte einloggen!");
        }
    });

    // --- FUNKTIONEN ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function toggleSheet(id, show) {
        document.getElementById('overlay').style.display = show ? 'block' : 'none';
        document.getElementById(id).classList.toggle('active', show);
    }

    function closeSheets() {
        document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
        document.getElementById('overlay').style.display = 'none';
    }

    // --- CHAT LOGIK ---
    async function createGroup() {
        const name = document.getElementById('new-group-name').value;
        if(!name) return;
        await db.collection('chats').add({
            name: name,
            type: 'group',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('new-group-name').value = "";
        closeSheets();
    }

    function loadChats() {
        db.collection('chats').onSnapshot(snap => {
            const list = document.getElementById('global-chat-list');
            list.innerHTML = "";
            
            // Standard Globaler Chat
            addChatToList("global", "Globaler Chat", "G");

            snap.forEach(doc => {
                const chat = doc.data();
                addChatToList(doc.id, chat.name, chat.name[0]);
            });
        });
    }

    function addChatToList(id, name, initial) {
        const div = document.createElement('div');
        div.className = "chat-item";
        div.onclick = () => openChat(id, name);
        div.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="chat-content">
                <div class="chat-top"><span class="chat-name">${name}</span><span class="chat-time">12:00</span></div>
                <div class="chat-preview">Tippe zum Chatten...</div>
            </div>
            <i class="fa fa-chevron-right" style="color:#ccc; font-size:12px;"></i>
        `;
        document.getElementById('global-chat-list').appendChild(div);
    }

    let unsubMessages = null;
    function openChat(id, name) {
        activeChatId = id;
        document.getElementById('active-chat-name').innerText = name;
        showScreen('screen-chat');
        
        if(unsubMessages) unsubMessages();
        unsubMessages = db.collection('chats').doc(id).collection('messages')
            .orderBy('ts', 'asc')
            .onSnapshot(snap => {
                const box = document.getElementById('message-list');
                box.innerHTML = "";
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.senderId === currentUser.uid;
                    const badge = m.senderEmail === ADMIN_EMAIL ? `<img src="${VERIFY_IMG}" class="verify-badge">` : "";
                    
                    const div = document.createElement('div');
                    div.className = `bubble ${isMe ? 'sent' : 'received'}`;
                    div.innerHTML = `
                        <div class="sender-tag">${m.senderName} ${badge}</div>
                        ${m.text ? `<div>${m.text}</div>` : ""}
                        ${m.imgUrl ? `<img src="${m.imgUrl}" style="max-width:100%; border-radius:10px; margin-top:5px;">` : ""}
                    `;
                    box.appendChild(div);
                });
                box.scrollTop = box.scrollHeight;
            });
    }

    async function sendText() {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;
        await db.collection('chats').doc(activeChatId).collection('messages').add({
            senderId: currentUser.uid,
            senderName: currentUser.displayName || "Nutzer",
            senderEmail: currentUser.email,
            text: input.value,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = "";
    }

    // --- BILD ZU URL LOGIK ---
    function triggerFile() { document.getElementById('file-hidden').click(); }

    async function uploadAndSend(input) {
        const file = input.files[0];
        if(!file) return;

        // "Bild zu URL umwandeln" -> Wir nutzen ImgBB (Kostenloser API Key nötig)
        // Alternativ kannst du es hier mit deiner eigenen Logik ersetzen.
        const formData = new FormData();
        formData.append("image", file);
        
        // HINWEIS: Ersetze 'DEIN_IMGBB_API_KEY' durch einen echten Key von imgbb.com
        try {
            const res = await fetch('https://api.imgbb.com/1/upload?key=DEIN_IMGBB_API_KEY', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            const url = data.data.url;

            await db.collection('chats').doc(activeChatId).collection('messages').add({
                senderId: currentUser.uid,
                senderName: currentUser.displayName || "Nutzer",
                senderEmail: currentUser.email,
                imgUrl: url,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) { alert("Upload Fehler"); }
        closeSheets();
    }
</script>
</body>
</html>
