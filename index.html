<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SFS Chat - Projekt 2026</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    
    <style>
        :root {
            --primary: #c2185b; /* Das Weinrot/Pink aus deinen Screens */
            --bg: #ffffff;
            --chat-bg: #f2f2f2;
            --text: #333;
            --blue-verify: #00a2ff;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #eee; display: flex; justify-content: center; height: 100vh; }

        #app-container {
            width: 100%;
            max-width: 450px;
            background: var(--bg);
            height: 100%;
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        /* Screens */
        .screen { display: none; flex-direction: column; height: 100%; width: 100%; }
        .screen.active { display: flex; }

        /* Login & Profile Setup */
        .auth-ui { padding: 40px 20px; text-align: center; }
        .auth-ui h1 { color: var(--primary); margin-bottom: 20px; font-size: 32px; }
        input[type="text"], input[type="email"], input[type="password"] {
            width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;
        }
        .btn {
            width: 100%; padding: 14px; border: none; border-radius: 25px; 
            font-weight: bold; cursor: pointer; transition: 0.2s; font-size: 16px; margin-top: 10px;
        }
        .btn-main { background: var(--primary); color: white; }
        .btn-google { background: #fff; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Header */
        header { 
            padding: 15px; display: flex; align-items: center; justify-content: space-between; 
            border-bottom: 1px solid #eee; background: #fff; z-index: 10;
        }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-title { font-size: 20px; font-weight: bold; color: #000; }

        /* Chat List */
        .list-container { flex: 1; overflow-y: auto; }
        .list-item { 
            display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #f5f5f5; 
            cursor: pointer; transition: 0.2s;
        }
        .list-item:hover { background: #fafafa; }
        .avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: #ddd; margin-right: 15px; }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .verify-badge { width: 16px; height: 16px; }

        /* Messages */
        #message-area { flex: 1; overflow-y: auto; padding: 15px; background: #fff; display: flex; flex-direction: column; }
        .msg-bubble { 
            max-width: 80%; padding: 10px 14px; border-radius: 18px; margin-bottom: 10px; 
            position: relative; line-height: 1.4; font-size: 15px;
        }
        .msg-bubble.sent { align-self: flex-end; background: #fce4ec; color: #000; border-bottom-right-radius: 4px; }
        .msg-bubble.received { align-self: flex-start; background: #f0f0f0; border-bottom-left-radius: 4px; }
        .msg-bubble img { max-width: 100%; border-radius: 10px; display: block; margin-top: 5px; }
        .sender-name { font-size: 11px; font-weight: bold; margin-bottom: 3px; display: flex; align-items: center; gap: 3px; }

        /* Input */
        .input-bar { padding: 10px; display: flex; align-items: center; gap: 10px; background: #fff; border-top: 1px solid #eee; }
        .icon-btn { font-size: 22px; color: var(--primary); cursor: pointer; }
        #chat-input { flex: 1; border: none; padding: 10px; background: #f5f5f5; border-radius: 20px; outline: none; }

        /* Modals */
        .overlay { 
            position: absolute; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.4); display: none; z-index: 20; 
        }
        .bottom-modal { 
            position: absolute; bottom: -100%; left: 0; width: 100%; 
            background: #fff; border-radius: 20px 20px 0 0; transition: 0.4s; z-index: 30; padding: 20px;
        }
        .bottom-modal.open { bottom: 0; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; cursor: pointer; }

        /* Loading */
        #loading-screen { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: white; 
            display: flex; justify-content: center; align-items: center; z-index: 999; 
        }
    </style>
</head>
<body>

<div id="loading-screen"><p>Lade SFS Chats...</p></div>

<div id="app-container">
    
    <div id="screen-login" class="screen auth-ui">
        <h1>SFS Chats</h1>
        <p>Bitte anmelden um fortzufahren</p>
        <input type="email" id="login-email" placeholder="E-Mail">
        <input type="password" id="login-pass" placeholder="Passwort">
        <button class="btn btn-main" onclick="handleAuth()">Anmelden / Registrieren</button>
        <button class="btn btn-google" onclick="handleGoogleAuth()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa/google.svg" width="18"> Mit Google anmelden
        </button>
    </div>

    <div id="screen-setup" class="screen auth-ui">
        <h1>Dein Profil</h1>
        <p>Wie sollen dich andere sehen?</p>
        <div style="margin: 20px 0;">
            <img id="setup-preview" class="avatar" src="https://via.placeholder.com/150" style="width: 100px; height: 100px;">
            <input type="file" id="setup-file" hidden accept="image/*" onchange="previewImage(this, 'setup-preview')">
            <button class="btn" onclick="document.getElementById('setup-file').click()">Bild wählen</button>
        </div>
        <input type="text" id="setup-name" placeholder="Anzeigename">
        <button class="btn btn-main" onclick="saveProfileData()">Profil speichern</button>
    </div>

    <div id="screen-main" class="screen">
        <header>
            <span class="header-title">Chats</span>
            <div class="header-left">
                <i class="fa-solid fa-circle-plus icon-btn"></i>
                <i class="fa-solid fa-bars icon-btn" onclick="openMenu('modal-settings')"></i>
            </div>
        </header>
        <div class="list-container">
            <div class="list-item" onclick="enterGlobalChat()">
                <img src="https://cdn-icons-png.flaticon.com/512/2583/2583157.png" class="avatar">
                <div class="item-info">
                    <div class="item-name">Globaler Gruppenchat</div>
                    <div style="color: #888; font-size: 13px;">Klicke um mit allen zu schreiben...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="screen-chat" class="screen">
        <header>
            <div class="header-left">
                <i class="fa-solid fa-chevron-left icon-btn" onclick="changeScreen('screen-main')"></i>
                <span class="header-title" id="active-chat-title">Global</span>
            </div>
            <i class="fa-solid fa-info-circle icon-btn"></i>
        </header>
        <div id="message-area"></div>
        <div class="input-bar">
            <i class="fa-solid fa-plus icon-btn" onclick="openMenu('modal-media')"></i>
            <input type="text" id="chat-input" placeholder="Nachricht...">
            <i class="fa-solid fa-paper-plane icon-btn" onclick="sendChatMessage()"></i>
        </div>
    </div>

    <div id="overlay" class="overlay" onclick="closeAllModals()"></div>

    <div id="modal-settings" class="bottom-modal">
        <div class="menu-item" onclick="changeScreen('screen-setup')"><i class="fa-solid fa-user-gear"></i> Account & Einstellungen</div>
        <div class="menu-item" onclick="handleLogout()" style="color: red;"><i class="fa-solid fa-right-from-bracket"></i> Ausloggen</div>
    </div>

    <div id="modal-media" class="bottom-modal">
        <div class="menu-item" onclick="document.getElementById('chat-img-file').click()"><i class="fa-solid fa-image"></i> Medien (Galerie)</div>
        <input type="file" id="chat-img-file" hidden accept="image/*" onchange="sendImageAsMessage(this)">
    </div>

</div>

<script>
    // --- FIREBASE INITIALISIERUNG ---
    const firebaseConfig = {
  apiKey: "AIzaSyBtZhw5zd96zJ5WYArLoMaGbpPjxF_gRUk",
  authDomain: "login-34727.firebaseapp.com",
  projectId: "login-34727",
  storageBucket: "login-34727.firebasestorage.app",
  messagingSenderId: "721582884449",
  appId: "1:721582884449:web:9271dcef860f4f76d44c20"
};

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let userProfile = null;
    const VERIFIED_EMAIL = "boxenjob5@gmail.com";
    const ROBLOX_BADGE = "https://static.wikia.nocookie.net/roblox/images/5/57/Verified_Badge.png";

    // --- AUTH FLOW ---
    auth.onAuthStateChanged(async (user) => {
        document.getElementById('loading-screen').style.display = 'none';
        if (user) {
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                userProfile = doc.data();
                changeScreen('screen-main');
            } else {
                changeScreen('screen-setup');
            }
        } else {
            changeScreen('screen-login');
        }
    });

    async function handleAuth() {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        if(!email || !pass) return alert("Bitte alles ausfüllen!");
        
        try {
            await auth.signInWithEmailAndPassword(email, pass);
        } catch (e) {
            try {
                await auth.createUserWithEmailAndPassword(email, pass);
            } catch (err) { alert(err.message); }
        }
    }

    async function handleGoogleAuth() {
        const provider = new firebase.auth.GoogleAuthProvider();
        await auth.signInWithPopup(provider);
    }

    function handleLogout() {
        auth.signOut();
        closeAllModals();
    }

    // --- PROFILE LOGIC ---
    async function saveProfileData() {
        const name = document.getElementById('setup-name').value;
        const imgElement = document.getElementById('setup-preview');
        if(!name) return alert("Name fehlt!");

        const data = {
            name: name,
            photo: imgElement.src,
            email: auth.currentUser.email,
            uid: auth.currentUser.uid
        };

        await db.collection('users').doc(auth.currentUser.uid).set(data);
        userProfile = data;
        changeScreen('screen-main');
    }

    // --- CHAT LOGIC ---
    let messageListener = null;

    function enterGlobalChat() {
        changeScreen('screen-chat');
        if(messageListener) messageListener(); // Alten Listener stoppen

        messageListener = db.collection('global_messages').orderBy('ts', 'asc').limitToLast(50)
            .onSnapshot(snap => {
                const area = document.getElementById('message-area');
                area.innerHTML = '';
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.uid === auth.currentUser.uid;
                    const isVerified = m.email === VERIFIED_EMAIL;

                    const div = document.createElement('div');
                    div.className = `msg-bubble ${isMe ? 'sent' : 'received'}`;
                    
                    let badge = isVerified ? `<img src="${ROBLOX_BADGE}" class="verify-badge">` : '';
                    
                    div.innerHTML = `
                        <div class="sender-name">${m.sender} ${badge}</div>
                        ${m.text ? `<div>${m.text}</div>` : ''}
                        ${m.image ? `<img src="${m.image}">` : ''}
                    `;
                    area.appendChild(div);
                });
                area.scrollTop = area.scrollHeight;
            });
    }

    async function sendChatMessage() {
        const input = document.getElementById('chat-input');
        if(!input.value.trim()) return;

        await db.collection('global_messages').add({
            uid: auth.currentUser.uid,
            sender: userProfile.name,
            email: auth.currentUser.email,
            text: input.value,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        input.value = '';
    }

    async function sendImageAsMessage(input) {
        if(!input.files[0]) return;
        const base64 = await toBase64(input.files[0]);
        
        await db.collection('global_messages').add({
            uid: auth.currentUser.uid,
            sender: userProfile.name,
            email: auth.currentUser.email,
            image: base64,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeAllModals();
    }

    // --- HELPERS ---
    function changeScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function openMenu(id) {
        document.getElementById('overlay').style.display = 'block';
        document.getElementById(id).classList.add('open');
    }

    function closeAllModals() {
        document.getElementById('overlay').style.display = 'none';
        document.querySelectorAll('.bottom-modal').forEach(m => m.classList.remove('open'));
    }

    function previewImage(input, targetId) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById(targetId).src = e.target.result;
            reader.readAsDataURL(input.files[0]);
        }
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
</script>

</body>
</html>
