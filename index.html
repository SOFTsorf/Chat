<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --sdui-pink: #d8507a;
            --sdui-pink-light: #fdf2f5;
            --sdui-bg: #f8f9fa;
            --sdui-text: #2c2c2c;
            --sdui-gray: #8e8e93;
            --sdui-border: #e2e2e2;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        
        body { 
            background-color: #f0f0f0; 
            height: 100dvh; /* Dynamischer Viewport gegen Browserleisten-Bug */
            display: flex; 
            justify-content: center; 
            overflow: hidden; 
        }

        #app {
            width: 100%;
            max-width: 500px;
            background: white;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .screen { display: none; flex-direction: column; height: 100%; width: 100%; background: white; }
        .screen.active { display: flex; }

        /* HEADER (Ref: 43352.jpg) */
        header { 
            padding: 15px 20px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
        }
        .header-left { display: flex; align-items: center; gap: 8px; }
        .header-left h1 { font-size: 34px; font-weight: 700; color: var(--sdui-text); }
        .plus-circle { 
            width: 30px; height: 30px; background: var(--sdui-pink-light); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: var(--sdui-pink); font-size: 20px; cursor: pointer;
        }
        .header-icons { display: flex; gap: 18px; font-size: 22px; color: #666; }

        /* SEARCH (Ref: 43352.jpg) */
        .search-area { padding: 0 15px 15px 15px; display: flex; gap: 10px; align-items: center; }
        .search-box { 
            flex: 1; background: #f0f1f3; border-radius: 12px; padding: 12px 12px 12px 45px; 
            border: none; font-size: 17px; position: relative;
        }
        .search-area i.fa-search { position: absolute; left: 30px; color: var(--sdui-gray); }

        /* CHAT LIST (Ref: 43352.jpg) */
        .chat-list { flex: 1; overflow-y: auto; border-top: 1px solid var(--sdui-border); }
        .chat-item { 
            display: flex; padding: 15px; border-bottom: 1px solid #f2f2f2; 
            align-items: flex-start; position: relative; cursor: pointer;
        }
        .avatar { 
            width: 55px; height: 55px; border-radius: 50%; background: #3a71a9; 
            color: white; display: flex; align-items: center; justify-content: center;
            font-size: 18px; font-weight: 500; margin-right: 15px; flex-shrink: 0; overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .chat-info { flex: 1; }
        .chat-info .name { font-weight: 600; font-size: 17px; display: flex; justify-content: space-between; }
        .chat-info .subtext { font-size: 14px; color: var(--sdui-gray); margin-top: 2px; }
        .chat-info .preview { font-size: 14px; color: #555; margin-top: 2px; }
        .chat-item .time { font-size: 13px; color: var(--sdui-gray); }
        .chat-item .chevron { margin-left: 10px; color: #ccc; font-size: 18px; }

        /* MESSAGES & NEWS CARDS (Ref: 43358.jpg) */
        #msg-container { flex: 1; overflow-y: auto; padding: 15px; background: #fff; display: flex; flex-direction: column; gap: 15px; }
        .date-divider { text-align: center; margin: 10px 0; color: var(--sdui-gray); font-size: 12px; }
        
        .news-card {
            background: white; border: 1px solid var(--sdui-border); border-radius: 12px;
            padding: 15px; max-width: 90%; align-self: flex-start;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); position: relative;
        }
        .news-header { color: var(--sdui-pink); font-size: 13px; font-weight: 700; margin-bottom: 8px; }
        .news-content { font-size: 15px; line-height: 1.4; }
        .news-btn { 
            margin-top: 15px; width: 100%; padding: 12px; background: var(--sdui-pink-light);
            color: var(--sdui-pink); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        
        .bubble-sent { 
            align-self: flex-end; background: #f2f2f7; border-radius: 18px; 
            padding: 10px 15px; max-width: 80%; font-size: 15px;
        }

        /* BOTTOM SHEETS (Ref: 43360.jpg & 43356.jpg) */
        .overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.4); display: none; z-index: 100; 
        }
        .bottom-sheet {
            position: absolute; bottom: -100%; left: 0; width: 100%; background: white;
            border-radius: 20px 20px 0 0; transition: 0.3s cubic-bezier(0.25, 0.1, 0.25, 1); 
            z-index: 101; padding: 25px 20px;
        }
        .bottom-sheet.active { bottom: 0; }
        .sheet-title { text-align: center; font-size: 20px; font-weight: 600; margin-bottom: 25px; position: relative; }
        .sheet-close { position: absolute; right: 0; top: 0; font-size: 22px; color: #ccc; cursor: pointer; }
        
        .action-grid { display: flex; justify-content: space-around; gap: 15px; }
        .action-item { text-align: center; flex: 1; }
        .action-icon { 
            height: 70px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #f0f0f0; border-radius: 12px; margin-bottom: 8px;
            font-size: 28px; color: var(--sdui-pink);
        }

        /* INPUT AREA (Ref: 43358.jpg) */
        .input-area { padding: 10px 15px; border-top: 1px solid var(--sdui-border); display: flex; align-items: center; gap: 12px; }
        .input-box { 
            flex: 1; background: #f0f1f3; border-radius: 25px; padding: 10px 15px; 
            border: 1px solid var(--sdui-pink); outline: none; font-size: 16px;
        }

        .verify-badge { width: 16px; height: 16px; vertical-align: middle; margin-left: 4px; }
    </style>
</head>
<body>

<div id="app">
    <div id="screen-login" class="screen active" style="justify-content:center; padding: 40px;">
        <h2 style="color:var(--sdui-pink); font-size: 32px; text-align:center; margin-bottom:30px;">Anmelden</h2>
        <input type="email" id="login-email" placeholder="E-Mail" style="width:100%; padding:15px; margin-bottom:10px; border:1px solid #ccc; border-radius:10px;">
        <input type="password" id="login-pass" placeholder="Passwort" style="width:100%; padding:15px; margin-bottom:20px; border:1px solid #ccc; border-radius:10px;">
        <button onclick="handleLogin()" style="width:100%; padding:15px; background:var(--sdui-pink); color:white; border:none; border-radius:25px; font-weight:bold;">Weiter</button>
        <button onclick="googleLogin()" style="width:100%; margin-top:10px; padding:15px; background:white; border:1px solid #ccc; border-radius:25px; display:flex; align-items:center; justify-content:center; gap:10px;">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/pwa/google.svg" width="20"> Mit Google anmelden
        </button>
    </div>

    <div id="screen-main" class="screen">
        <header>
            <div class="header-left">
                <h1>Chats</h1>
                <div class="plus-circle" onclick="toggleSheet('sheet-create', true)"><i class="fa fa-plus"></i></div>
            </div>
            <div class="header-icons">
                <i class="fa-regular fa-bell"></i>
                <i class="fa-solid fa-circle-info"></i>
                <i class="fa-solid fa-bars" onclick="toggleSheet('sheet-menu', true)"></i>
            </div>
        </header>
        <div class="search-area">
            <i class="fa fa-search"></i>
            <input type="text" class="search-box" placeholder="Suchen">
            <i class="fa-solid fa-sliders" style="color:var(--sdui-gray); font-size: 20px;"></i>
        </div>
        <div class="chat-list" id="list-container">
            </div>
    </div>

    <div id="screen-chat" class="screen">
        <header style="justify-content: flex-start; gap: 15px; border-bottom: 1px solid #eee;">
            <i class="fa fa-chevron-left" style="color:var(--sdui-pink); font-size:22px; cursor:pointer;" onclick="showScreen('screen-main')"></i>
            <div class="avatar" style="width:40px; height:40px; margin:0;" id="active-avatar">?</div>
            <div onclick="alert('Info')">
                <b id="active-name" style="font-size:16px;">Chat</b><br>
                <small style="color:var(--sdui-gray);">Hier klicken für Chat Info</small>
            </div>
        </header>
        <div id="msg-container"></div>
        <div class="input-area">
            <i class="fa fa-plus" style="color:var(--sdui-pink); font-size:24px; cursor:pointer;" onclick="toggleSheet('sheet-actions', true)"></i>
            <input type="text" id="chat-input" class="input-box" placeholder="Neue Nachricht">
            <i class="fa-solid fa-paper-plane" style="color:var(--sdui-pink); font-size:22px; cursor:pointer;" onclick="sendText()"></i>
        </div>
    </div>

    <div id="overlay" class="overlay" onclick="closeAll()"></div>

    <div id="sheet-actions" class="bottom-sheet">
        <div class="sheet-title">
            Aktion auswählen
            <div class="sheet-close" onclick="closeAll()"><i class="fa-solid fa-circle-xmark"></i></div>
        </div>
        <div class="action-grid">
            <div class="action-item" onclick="triggerFile()">
                <div class="action-icon"><i class="fa-solid fa-camera"></i></div>
                <div style="color:var(--sdui-pink); font-weight:500;">Kamera</div>
            </div>
            <div class="action-item" onclick="triggerFile()">
                <div class="action-icon"><i class="fa-solid fa-image"></i></div>
                <div style="color:var(--sdui-pink); font-weight:500;">Medien</div>
            </div>
        </div>
        <input type="file" id="file-input" hidden accept="image/*" onchange="uploadFile(this)">
    </div>

    <div id="sheet-menu" class="bottom-sheet">
        <div style="display:flex; align-items:center; gap:15px; padding:15px 0; cursor:pointer;" onclick="showProfileSettings()">
            <i class="fa-solid fa-gear" style="color:var(--sdui-pink); font-size:20px;"></i>
            <span style="font-size:18px;">Account & Einstellungen</span>
        </div>
        <div style="display:flex; align-items:center; gap:15px; padding:15px 0; cursor:pointer;">
            <i class="fa-solid fa-users" style="color:var(--sdui-pink); font-size:20px;"></i>
            <span style="font-size:18px;">Meine Gruppen</span>
        </div>
        <hr style="border:none; border-top:1px solid #eee; margin:10px 0;">
        <div style="display:flex; align-items:center; gap:15px; padding:15px 0; color:#d93025; cursor:pointer;" onclick="firebase.auth().signOut()">
            <i class="fa-solid fa-power-off" style="font-size:20px;"></i>
            <span style="font-size:18px; font-weight:500;">Ausloggen</span>
        </div>
    </div>

    <div id="sheet-create" class="bottom-sheet">
        <div class="sheet-title">Neue Gruppe</div>
        <input type="text" id="group-name-input" class="input-box" style="width:100%; margin-bottom:20px;" placeholder="Name der Gruppe">
        <button onclick="createNewGroup()" style="width:100%; padding:15px; background:var(--sdui-pink); color:white; border:none; border-radius:12px; font-weight:bold;">Erstellen</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const firebaseConfig = {
  apiKey: "AIzaSyBtZhw5zd96zJ5WYArLoMaGbpPjxF_gRUk",
  authDomain: "login-34727.firebaseapp.com",
  projectId: "login-34727",
  storageBucket: "login-34727.firebasestorage.app",
  messagingSenderId: "721582884449",
  appId: "1:721582884449:web:9271dcef860f4f76d44c20"
    const IMGBB_KEY = "1cb3871dd6829d7133f3285c289ffc0a"; // Kostenlos auf imgbb.com holen
    const ADMIN_EMAIL = "boxenjob5@gmail.com";
    const ROBLOX_BADGE = "https://upload.wikimedia.org/wikipedia/commons/e/e4/Twitter_Verified_Badge.svg";

    let currentUser = null;
    let activeChatId = null;

    // --- AUTH LOGIC ---
    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            showScreen('screen-main');
            loadChats();
        } else {
            showScreen('screen-login');
        }
    });

    async function handleLogin() {
        const e = document.getElementById('login-email').value;
        const p = document.getElementById('login-pass').value;
        try { await auth.signInWithEmailAndPassword(e, p); } 
        catch { await auth.createUserWithEmailAndPassword(e, p); }
    }

    function googleLogin() { auth.signInWithRedirect(new firebase.auth.GoogleAuthProvider()); }

    // --- NAVIGATION & UI ---
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        closeAll();
    }

    function toggleSheet(id, show) {
        document.getElementById('overlay').style.display = show ? 'block' : 'none';
        document.getElementById(id).classList.toggle('active', show);
    }

    function closeAll() {
        document.querySelectorAll('.bottom-sheet').forEach(s => s.classList.remove('active'));
        document.getElementById('overlay').style.display = 'none';
    }

    function triggerFile() { document.getElementById('file-input').click(); }

    // --- FIREBASE LOGIK ---
    function loadChats() {
        // Wir laden alle Gruppen aus der Collection 'chats'
        db.collection('chats').onSnapshot(snap => {
            const container = document.getElementById('list-container');
            container.innerHTML = "";
            
            // Standard Global Chat
            renderChatItem("global", "Globaler Chat", "G", "Sdui System", "Willkommen!");

            snap.forEach(doc => {
                const c = doc.data();
                renderChatItem(doc.id, c.name, c.name[0], "Gruppe", "Keine neuen Nachrichten");
            });
        });
    }

    function renderChatItem(id, name, initial, sub, preview) {
        const item = document.createElement('div');
        item.className = "chat-item";
        item.onclick = () => openChat(id, name);
        item.innerHTML = `
            <div class="avatar">${initial}</div>
            <div class="chat-info">
                <div class="name"><span>${name}</span> <span class="time">14:25</span></div>
                <div class="subtext">${sub} <i class="fa fa-chevron-down" style="font-size:10px; margin-left:5px;"></i></div>
                <div class="preview">${preview}</div>
            </div>
            <i class="fa fa-chevron-right chevron"></i>
        `;
        document.getElementById('list-container').appendChild(item);
    }

    let unsubMsgs = null;
    function openChat(id, name) {
        activeChatId = id;
        document.getElementById('active-name').innerText = name;
        document.getElementById('active-avatar').innerText = name[0];
        showScreen('screen-chat');

        if(unsubMsgs) unsubMsgs();
        unsubMsgs = db.collection('chats').doc(id).collection('messages').orderBy('ts', 'asc')
            .onSnapshot(snap => {
                const container = document.getElementById('msg-container');
                container.innerHTML = `<div class="date-divider">HEUTE</div>`;
                snap.forEach(doc => {
                    const m = doc.data();
                    const isMe = m.uid === currentUser.uid;
                    const badge = m.email === ADMIN_EMAIL ? `<img src="${ROBLOX_BADGE}" class="verify-badge">` : "";
                    
                    const div = document.createElement('div');
                    if(isMe) {
                        div.className = "bubble-sent";
                        div.innerText = m.text || "Bild gesendet";
                    } else {
                        // News Card Style für empfangene Nachrichten (Ref: 43358.jpg)
                        div.className = "news-card";
                        div.innerHTML = `
                            <div class="news-header">${m.sender} ${badge}</div>
                            <div class="news-content">${m.text || ""}</div>
                            ${m.img ? `<img src="${m.img}" style="width:100%; border-radius:8px; margin-top:10px;">` : ""}
                            <button class="news-btn">Details anzeigen</button>
                        `;
                    }
                    container.appendChild(div);
                });
                container.scrollTop = container.scrollHeight;
            });
    }

    async function sendText() {
        const val = document.getElementById('chat-input').value;
        if(!val) return;
        await db.collection('chats').doc(activeChatId).collection('messages').add({
            uid: currentUser.uid,
            sender: currentUser.displayName || currentUser.email.split('@')[0],
            email: currentUser.email,
            text: val,
            ts: firebase.firestore.FieldValue.serverTimestamp()
        });
        document.getElementById('chat-input').value = "";
    }

    // --- BILD UPLOAD LOGIK (URL) ---
    async function uploadFile(input) {
        const file = input.files[0];
        if(!file) return;

        const formData = new FormData();
        formData.append("image", file);

        try {
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_KEY}`, {
                method: 'POST',
                body: formData
            });
            const json = await res.json();
            const url = json.data.url;

            await db.collection('chats').doc(activeChatId).collection('messages').add({
                uid: currentUser.uid,
                sender: currentUser.displayName || "User",
                email: currentUser.email,
                img: url,
                ts: firebase.firestore.FieldValue.serverTimestamp()
            });
        } catch (e) { alert("Fehler beim Hochladen"); }
        closeAll();
    }

    async function createNewGroup() {
        const name = document.getElementById('group-name-input').value;
        if(!name) return;
        await db.collection('chats').add({ name: name, createdAt: new Date() });
        document.getElementById('group-name-input').value = "";
        closeAll();
    }
</script>
</body>
</html>
